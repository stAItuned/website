name: Deploy Website with Updated Content

on:
  # Triggered when content is updated
  repository_dispatch:
    types: [content-updated]
  
  # Manual deployment trigger
  workflow_dispatch:
  
  # Also trigger on direct pushes to main/master
  push:
    branches: [ main, master, react-migrate ]

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Update CMS submodule (if triggered by CMS)
        if: github.event_name == 'repository_dispatch'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          echo "üîÑ Updating CMS submodule to latest..."
          git submodule update --remote cms
          
          # Check if there are changes
          if ! git diff --quiet HEAD -- cms; then
            echo "üìù CMS submodule has updates"
            git add cms
            git commit -m "üîÑ Auto-update content from CMS
            
            Triggered by: ${{ github.event.client_payload.pusher }}
            CMS commit: ${{ github.event.client_payload.sha }}
            "
            git push origin ${{ github.ref_name }}
            echo "‚úÖ CMS submodule updated and committed"
          else
            echo "‚ÑπÔ∏è No changes in CMS submodule"
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build website
        run: |
          echo "üèóÔ∏è Building website with updated content..."
          npm run build
          echo "‚úÖ Build successful"
      
      - name: Deploy to Vercel (if configured)
        if: env.VERCEL_TOKEN != ''
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: '--prod'
      
      - name: Deployment summary
        run: |
          echo "üöÄ Deployment Summary"
          echo "===================="
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "Trigger: CMS content update"
            echo "CMS Pusher: ${{ github.event.client_payload.pusher }}"
            echo "CMS Commit: ${{ github.event.client_payload.sha }}"
          else
            echo "Trigger: Direct push to website repository"
          fi
          echo "Website Commit: ${{ github.sha }}"
          echo "‚úÖ Website successfully updated and deployed!"
