name: External Webhook Trigger

on:
  # Can be triggered via GitHub API or external services
  repository_dispatch:
    types: 
      - webhook-update
      - external-trigger
      - cms-update
      - deploy-request

jobs:
  external-webhook-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Log webhook trigger
        run: |
          echo "🔔 Webhook triggered from external source"
          echo "Event type: ${{ github.event.action }}"
          echo "Client payload: ${{ toJson(github.event.client_payload) }}"
      
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update CMS submodule
        run: |
          git config --global user.name 'Webhook Updater'
          git config --global user.email 'webhook@staituned.com'
          
          echo "🔄 Updating CMS submodule from webhook trigger..."
          git submodule update --remote cms
          
          # Check for changes
          if ! git diff --quiet HEAD -- cms; then
            git add cms
            git commit -m "🔗 Update content via external webhook
            
            Trigger: ${{ github.event.action }}
            Source: ${{ github.event.client_payload.source || 'external' }}
            Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            "
            git push
            echo "✅ Content updated successfully via webhook"
            echo "webhook_updated=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️ No content changes detected"
            echo "webhook_updated=false" >> $GITHUB_OUTPUT
          fi
        id: update_content
      
      - name: Setup Node.js
        if: steps.update_content.outputs.webhook_updated == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies and build
        if: steps.update_content.outputs.webhook_updated == 'true'
        run: |
          npm ci
          npm run build
          echo "✅ Build completed successfully"
      
      - name: Deploy notification
        if: steps.update_content.outputs.webhook_updated == 'true'
        run: |
          echo "🚀 Webhook Update Summary"
          echo "========================"
          echo "Trigger: ${{ github.event.action }}"
          echo "Source: ${{ github.event.client_payload.source || 'external webhook' }}"
          echo "Content updated: ✅"
          echo "Build status: ✅"
          echo "Ready for deployment: ✅"
