name: Deploy to Firebase Production

# ===================================
# FIREBASE PRODUCTION DEPLOYMENT
# ===================================
# Branches: main, master
# Domain: https://staituned.com
# Environment: Production
# Platform: Firebase Hosting
# ===================================

on:
  # Production branches - deploy to Firebase production
  push:
    branches: [ main, master ]
  
  # Manual deployment trigger
  workflow_dispatch:
  
  # Repository dispatch for CMS updates
  repository_dispatch:
    types: [content-updated, production-content-updated]

env:
  DEPLOYMENT_PLATFORM: "Firebase Hosting"
  DEPLOYMENT_URL: "https://staituned.com"
  ENVIRONMENT: "production"
  FIREBASE_PROJECT: "staituned-production-163f4"

# Ensure the workflow has necessary permissions
permissions:
  contents: write
  actions: read

jobs:
  deploy-firebase-production:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📋 Firebase Deployment Info
        run: |
          echo "🔥 FIREBASE PRODUCTION DEPLOYMENT"
          echo "=================================="
          echo "🌐 Platform: ${{ env.DEPLOYMENT_PLATFORM }}"
          echo "🔗 URL: ${{ env.DEPLOYMENT_URL }}"
          echo "🌟 Environment: ${{ env.ENVIRONMENT }}"
          echo "🌿 Branch: ${{ github.ref_name }}"
          echo "📝 Commit: ${{ github.sha }}"
          echo "=================================="
      
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          fetch-depth: 0
      
      - name: Update CMS submodule (if triggered by CMS)
        if: github.event_name == 'repository_dispatch'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          echo "🔄 Updating CMS submodule to latest..."
          git submodule update --remote cms
          
          # Check if there are changes
          if ! git diff --quiet HEAD -- cms; then
            echo "📝 CMS submodule has updates"
            git add cms
            git commit -m "🔄 Auto-update content from CMS (Firebase Production)
            
            Triggered by: ${{ github.event.client_payload.pusher }}
            CMS commit: ${{ github.event.client_payload.sha }}
            "
            git push origin ${{ github.ref_name }}
            echo "✅ CMS submodule updated and committed"
          else
            echo "ℹ️ No changes in CMS submodule"
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build website for Firebase (Static Export)
        run: |
          echo "🏗️ Building website for Firebase deployment..."
          export NODE_ENV=production
          export NEXT_PUBLIC_BASE_URL=${{ env.DEPLOYMENT_URL }}
          export FIREBASE_DEPLOYMENT=true
          npm run build:firebase
          echo "✅ Firebase static build successful"
          
          # Verify build output
          if [ -d "out" ]; then
            echo "📁 Static files generated in 'out' directory"
            ls -la out/
          else
            echo "❌ No 'out' directory found!"
            exit 1
          fi
      
      - name: Deploy to Firebase Hosting (Production)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.WEBSITE_DISPATCH_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: 'staituned-production-163f4'
          channelId: live
          target: production
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
      
      - name: Firebase Production Deployment Summary
        run: |
          echo "🔥 FIREBASE PRODUCTION DEPLOYMENT COMPLETE"
          echo "==========================================="
          echo "🌐 Live URL: ${{ env.DEPLOYMENT_URL }}"
          echo "🔥 Platform: ${{ env.DEPLOYMENT_PLATFORM }}"
          echo "🌟 Environment: ${{ env.ENVIRONMENT }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "🔄 Trigger: CMS content update"
            echo "👤 CMS Pusher: ${{ github.event.client_payload.pusher }}"
            echo "📝 CMS Commit: ${{ github.event.client_payload.sha }}"
          else
            echo "🔄 Trigger: Direct push to ${{ github.ref_name }} branch"
          fi
          echo "📝 Website Commit: ${{ github.sha }}"
          echo "✅ Firebase production website successfully deployed!"
